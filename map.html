<script>
  window.addEventListener('load', async () => {
    const map = L.map('map').setView([36.5, 127.8], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    let myMarker = null;
    document.getElementById('locBtn').onclick = () => {
      if (!navigator.geolocation) return alert('ìœ„ì¹˜ ê¸°ëŠ¥ ë¯¸ì§€ì›');
      navigator.geolocation.getCurrentPosition(p=>{
        const {latitude:lat, longitude:lng} = p.coords;
        if (myMarker) myMarker.remove();
        myMarker = L.marker([lat,lng]).addTo(map).bindPopup('ë‚´ ìœ„ì¹˜').openPopup();
        map.setView([lat,lng], 13);
      }, ()=>alert('ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆì–´ìš”'), {enableHighAccuracy:true, timeout:10000});
    };

    // âœ… êµì¸ìˆ˜ì— ë”°ë¥¸ ìƒ‰ìƒ
    function colorByMembers(n){
      const num = parseFloat(n || 0);
      if (num <= 50) return '#BDBDBD';       // 0~50: íšŒìƒ‰
      if (num <= 100) return '#FACC15';      // 50~100: ë…¸ë‘
      if (num <= 300) return '#A78BFA';      // 100~300: ë³´ë¼
      return '#EF4444';                      // 300+: ë¹¨ê°•
    }

    const overlays = {};

    async function addRegionLayer(label, url){
      const res = await fetch(url);
      if (!res.ok) throw new Error('ëª» ë¶ˆëŸ¬ì˜´: ' + url);
      const geo = await res.json();

      const layer = L.geoJSON(geo, {
        pointToLayer: (f, latlng) => {
          const p = f.properties || {};
          const n = p.members_num || p.members || 0;
          const c = colorByMembers(n);

          return L.circleMarker(latlng, {
            radius: 7,           // ğŸ”¥ ì˜ ë³´ì´ê²Œ í¬ê²Œ
            color: '#000',       // í…Œë‘ë¦¬
            weight: 1,
            fillColor: c,
            fillOpacity: 0.9
          });
        },
        onEachFeature: (f, l) => {
          const p = f.properties || {};
          l.bindPopup(`
            <b>${p.name || 'êµíšŒ'}</b><br/>
            ${p.address || ''}<br/>
            êµì¸ìˆ˜: ${p.members_num || p.members || 'ë¯¸ìƒ'}ëª…
          `);
        }
      });

      overlays[label] = layer;
    }

    await Promise.all([
      addRegionLayer('ì„œìš¸', './data/region/seoul.geojson'),
      addRegionLayer('ê²½ê¸°', './data/region/gyeonggi.geojson'),
      addRegionLayer('ì¶©ì²­', './data/region/chungcheong.geojson'),
      addRegionLayer('ì „ë¼', './data/region/jeolla.geojson'),
      addRegionLayer('ê°•ì›', './data/region/gangwon.geojson'),
      addRegionLayer('ê²½ìƒ', './data/region/gyeongsang.geojson'),
      addRegionLayer('ì œì£¼', './data/region/jeju.geojson'),
    ]);

    L.control.layers(null, overlays, { collapsed:false }).addTo(map);
  });
</script>
